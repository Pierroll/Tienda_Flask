{% extends 'base.html' %}

{% block title %} Cart {% endblock %}

{% block styles %}
<style>
    :root {
        --orange-border: #ff9900;
        --orange-glow: rgba(255, 153, 0, 0.2);
        --orange-gradient: linear-gradient(45deg, #ff9900, #ffb700);
    }

    .container {
        padding: 2rem 0;
    }

    h1 {
        color: var(--text-color) !important;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .card {
        background: var(--nav-bg);
        border: 1px solid var(--orange-border);
        border-radius: 15px;
        box-shadow: 0 5px 15px var(--orange-glow);
        overflow: hidden;
    }

    .card-body {
        padding: 2rem;
    }

    .img-thumbnail {
        background: var(--bg-color);
        border: 1px solid var(--orange-border);
        border-radius: 10px;
        padding: 0.5rem;
        transition: all 0.3s ease;
    }

    .img-thumbnail:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px var(--orange-glow);
    }

    h3 {
        color: var(--text-color);
        font-weight: 600;
        margin-bottom: 1rem;
    }

    label {
        color: var(--text-color);
        font-weight: 600;
        margin-right: 1rem;
    }

    .btn {
        padding: 0.5rem 1rem;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px var(--orange-glow);
    }

    .btn-secondary {
        background: var(--nav-bg);
        border: 1px solid var(--orange-border);
        color: var(--text-color);
    }

    .btn-primary {
        background: var(--orange-gradient);
        border: none;
        color: white;
    }

    .fas {
        color: var(--orange-border);
        transition: all 0.3s ease;
    }

    .fas:hover {
        transform: scale(1.1);
        color: var(--text-color);
    }

    .list-group-item {
        background: transparent;
        border-color: var(--orange-border);
        color: var(--text-color);
    }

    .list-group-item:first-child {
        border-top: none;
    }

    strong {
        color: var(--orange-border);
    }

    small {
        color: var(--text-color);
        opacity: 0.8;
    }

    hr {
        border-color: var(--orange-border);
        opacity: 0.2;
    }

    #quantity {
        color: var(--text-color);
        font-weight: 600;
        margin: 0 1rem;
    }

    .remove-cart {
        color: #e74c3c;
        font-weight: 600;
    }

    .remove-cart:hover {
        color: #c0392b;
        text-decoration: none;
    }
</style>
{% endblock %}

{% block body %}

<div class="container my-5">
    <div class="row">
        {% if cart %}

        <h1 class="text-center mb-5">Shopping Cart</h1>
        <div class="col-sm-8">
            <div class="card">
                <div class="card-body">

                    {% for item in cart %}

                    <div class="row">
                        <div class="col-sm-3 text-center align-self-center">
                            <img src="{{ item.product.product_picture }}" alt="" class="img-fluid img-thumbnail shadow-sm" height="150px" width="150px">
                        </div>
                        <div class="col-sm-9">
                            <div>
                                <h3>{{ item.product.product_name }}</h3>
                                <div class="my-3">
                                    <label for="quantity">Quantity</label>
                                    <a class="minus-cart btn" pid="{{item.id}}"><i class="fas fa-minus-square fa-lg"></i></a>
                                    <span id="quantity-{{item.id}}" class="mx-2">{{ item.quantity }}</span>
                                    <a class="plus-cart btn" pid="{{ item.id }}" data-stock="{{ item.product.stock_quantity }}"><i class="fas fa-plus-square fa-lg"></i></a>
                                </div>

                                <div class="d-flex justify-content-between">
                                    <p class="mb-0"><span><strong>Ksh {{ item.product.current_price }}</strong></span></p>
                                    <a href="" class="remove-cart btn btn-sm btn-secondary mr-3" pid="{{item.id}}">Remove</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>

                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-sm-4">
            <div class="card">
                <div class="card-body">
                    <h3>Cart Summary</h3>
                    <hr color="black">
                    <ul class="list-group">
                        {% for item in cart %}
                        <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0">
                            <strong>{{item.product.product_name}}</strong>
                            <span>Ksh {{'%0.2f'|format(item.product.current_price|float)}} X <span id="quantity{{item.id}}">{{ item.quantity }}</span></span>
                        </li>
                        {% endfor %}

                        <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0">
                            Amount 
                            <span>Ksh <span id="amount_tt">{% if amount %}{{'%0.2f'|format(amount|float)}}{% else %}0.00{% endif %}</span></span>
                        </li>

                        <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 mb-3">
                            <div style="margin-top: 15px;">
                                <strong>Total</strong><small>(Including Shipping)</small>
                            </div>
                            <span><strong>Ksh </strong><span id="totalamount"><strong>{% if total %}{{'%0.2f'|format(total|float)}}{% else %}0.00{% endif %}</strong></span></span>
                        </li>
                    </ul>

                    <div class="d-grid"><a href="/place-order" class="btn btn-primary">Place Order</a></div>
                </div>
            </div>
        </div>

        {% else %}

        <h1 class="text-center mb-5">Your Cart is Empty</h1>

        {% endif %}
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Función para actualizar la cantidad en el carrito
    function updateCart(pid, newQuantity) {
        // Mostrar indicador de carga
        const $buttons = $(`.plus-cart[pid="${pid}"], .minus-cart[pid="${pid}"]`);
        $buttons.prop('disabled', true);
        
        // Enviar solicitud al servidor
        $.ajax({
            url: '/update-cart',
            method: 'POST',
            data: {
                'pid': pid,
                'quantity': newQuantity,
                'csrf_token': '{{ csrf_token() }}'
            },
            success: function(response) {
                if (response.success) {
                    // Actualizar la cantidad mostrada
                    $(`#quantity-${pid}`).text(newQuantity);
                    
                    // Actualizar totales
                    if (response.amount !== undefined) {
                        $('#amount_tt').text(parseFloat(response.amount).toFixed(2));
                        $('#totalamount strong').text(parseFloat(response.total).toFixed(2));
                    }
                    
                    // Actualizar estado de los botones
                    $(`.minus-cart[pid="${pid}"]`).prop('disabled', newQuantity <= 1);
                    
                    // Actualizar botón de + si alcanzamos el stock máximo
                    const maxStock = parseInt($(`.plus-cart[pid="${pid}"]`).data('stock'));
                    $(`.plus-cart[pid="${pid}"]`).prop('disabled', newQuantity >= maxStock);
                } else {
                    alert(response.message || 'Error al actualizar el carrito');
                }
            },
            error: function(xhr) {
                console.error('Error:', xhr);
                const response = xhr.responseJSON || {};
                alert(response.message || 'Error al conectar con el servidor');
            },
            complete: function() {
                $buttons.prop('disabled', false);
            }
        });
    }

    // Botón + (suma 1)
    $(document).on('click', '.plus-cart', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const $button = $(this);
        if ($button.prop('disabled')) return;
        
        const pid = $button.attr('pid');
        const $quantityDisplay = $(`#quantity-${pid}`);
        const current = parseInt($quantityDisplay.text()) || 0;
        const maxStock = parseInt($button.data('stock')) || 1;
        
        if (current >= maxStock) {
            alert(`No hay suficiente stock. Stock disponible: ${maxStock}`);
            return;
        }
        
        updateCart(pid, current + 1);
    });

    // Botón - (resta 1, mínimo 1)
    $(document).on('click', '.minus-cart', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const $button = $(this);
        if ($button.prop('disabled')) return;
        
        const pid = $button.attr('pid');
        const $quantityDisplay = $(`#quantity-${pid}`);
        const current = parseInt($quantityDisplay.text()) || 1;
        
        if (current > 1) {
            updateCart(pid, current - 1);
        } else {
            // Si es 1, preguntar si quiere eliminar
            if (confirm('¿Desea eliminar este producto del carrito?')) {
                $(`.remove-cart[pid="${pid}"]`).click();
            }
        }
    });

    // Eliminar del carrito
    $(document).on('click', '.remove-cart', function(e) {
        e.preventDefault();
        const pid = $(this).attr('pid');
        
        if (confirm('¿Está seguro de que desea eliminar este producto del carrito?')) {
            // Mostrar indicador de carga
            const $button = $(this);
            $button.prop('disabled', true);
            
            $.ajax({
                url: '/remove-cart',
                method: 'POST',
                data: {
                    'pid': pid,
                    'csrf_token': '{{ csrf_token() }}'
                },
                success: function(response) {
                    if (response.success) {
                        // Recargar la página para actualizar la vista
                        location.reload();
                    } else {
                        alert(response.message || 'Error al eliminar del carrito');
                        $button.prop('disabled', false);
                    }
                },
                error: function(xhr) {
                    console.error('Error:', xhr);
                    alert('Error al conectar con el servidor');
                    $button.prop('disabled', false);
                }
            });
        }
    });
});
</script>
{% endblock %}
